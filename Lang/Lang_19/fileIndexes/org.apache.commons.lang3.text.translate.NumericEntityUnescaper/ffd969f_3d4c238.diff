28a29,30
> 
> 
36c38,40
<         if(input.charAt(index) == '&' && index < (input.length() - 1) && input.charAt(index + 1) == '#') {
---
>         int seqEnd = input.length();
>         
>         if(input.charAt(index) == '&' && index < seqEnd - 2 && input.charAt(index + 1) == '#') {
43a48,52
> 
>                 
>                 if(start == seqEnd) {
>                     return 0;
>                 }
47c56,60
<             while(input.charAt(end) != ';') {
---
>             
>             while(end < seqEnd && ( (input.charAt(end) >= '0' && input.charAt(end) <= '9') ||
>                                     (input.charAt(end) >= 'a' && input.charAt(end) <= 'f') ||
>                                     (input.charAt(end) >= 'A' && input.charAt(end) <= 'F') ) )
>             {
58a72
>             System.err.println("FAIL: " + input.subSequence(start, end) + "[" + start +"]["+ end +"]");
69c83,86
<             return 2 + (end - start) + (isHex ? 1 : 0) + 1;
---
> 
>             boolean semiNext = (end != seqEnd) && (input.charAt(end) == ';');
> 
>             return 2 + (end - start) + (isHex ? 1 : 0) + (semiNext ? 1 : 0);
