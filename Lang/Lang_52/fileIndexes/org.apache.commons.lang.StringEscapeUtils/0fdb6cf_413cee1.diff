464,470d463
<     
< 
< 
< 
< 
< 
< 
472,492c465
<         StringBuffer buf = new StringBuffer(str.length() * 2);
<         int i;
<         for (i = 0; i < str.length(); ++i) {
<             char ch = str.charAt(i);
<             String entity = entities.entityName(ch);
<             if (entity == null) {
<                 if (((int) ch) > 0x7F) {
<                     int intValue = ((int) ch);
<                     buf.append("&#");
<                     buf.append(intValue);
<                     buf.append(';');
<                 } else {
<                     buf.append(ch);
<                 }
<             } else {
<                 buf.append('&');
<                 buf.append(entity);
<                 buf.append(';');
<             }
<         }
<         return buf.toString();
---
>         return entities.escape(str);
496,525c469
<         StringBuffer buf = new StringBuffer(str.length());
<         int i;
<         for (i = 0; i < str.length(); ++i) {
<             char ch = str.charAt(i);
<             if (ch == '&') {
<                 int semi = str.indexOf(';', i + 1);
<                 if (semi == -1) {
<                     buf.append(ch);
<                     continue;
<                 }
<                 String entity = str.substring(i + 1, semi);
<                 Integer iso;
<                 if (entity.charAt(0) == '#') {
<                     iso = new Integer(entity.substring(1));
<                 } else {
<                     iso = entities.entityValue(entity);
<                 }
<                 if (iso == null) {
<                     buf.append('&');
<                     buf.append(entity);
<                     buf.append(';');
<                 } else {
<                     buf.append((char) (iso.intValue()));
<                 }
<                 i = semi;
<             } else {
<                 buf.append(ch);
<             }
<         }
<         return buf.toString();
---
>         return entities.unescape(str);
