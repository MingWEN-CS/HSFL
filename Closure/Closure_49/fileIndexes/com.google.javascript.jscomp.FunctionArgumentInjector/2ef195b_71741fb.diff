38a39,42
>   
>   
>   static final String THIS_MARKER = "this";
> 
52c56
<   static Node inject(Node node, Node parent,
---
>   static Node inject(AbstractCompiler compiler, Node node, Node parent,
66a71,88
>     } else if (node.getType() == Token.THIS) {
>       Node replacementTemplate = replacements.get(THIS_MARKER);
>       Preconditions.checkNotNull(replacementTemplate);
>       if (replacementTemplate.getType() != Token.THIS) {
>         
>         
>         Node replacement = replacementTemplate.cloneTree();
>         parent.replaceChild(node, replacement);
> 
>         
>         
>         
>         if (NodeUtil.mayHaveSideEffects(replacementTemplate, compiler)) {
>           replacements.remove(THIS_MARKER);
>         }
> 
>         return replacement;
>       }
72c94
<       c = inject(c, node, replacements);
---
>       c = inject(compiler, c, node, replacements);
89,97c111,117
<     if (callNode.getFirstChild().getType() != Token.NAME) {
<       if (NodeUtil.isFunctionObjectCall(callNode)) {
<         
<         Preconditions.checkNotNull(cArg);
<         Preconditions.checkState(cArg.getType() == Token.THIS);
<         cArg = cArg.getNext();
<       } else {
<         Preconditions.checkState(!NodeUtil.isFunctionObjectApply(callNode));
<       }
---
>     if (cArg != null && NodeUtil.isFunctionObjectCall(callNode)) {
>       argMap.put(THIS_MARKER, cArg);
>       cArg = cArg.getNext();
>     } else {
>       
>       Preconditions.checkState(!NodeUtil.isFunctionObjectApply(callNode));
>       argMap.put(THIS_MARKER, NodeUtil.newUndefinedNode(callNode));
382a403,404
>         } else if (n.getType() == Token.THIS) {
>           parametersReferenced.add(THIS_MARKER);
