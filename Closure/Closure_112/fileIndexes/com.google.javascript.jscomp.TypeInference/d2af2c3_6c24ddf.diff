1160a1161,1182
>   private static class TemplateTypeMapReplacer extends ModificationVisitor {
>     private final TemplateTypeMap replacements;
>     boolean madeChanges = false;
> 
>     TemplateTypeMapReplacer(
>         JSTypeRegistry registry, TemplateTypeMap replacements) {
>       super(registry);
>       this.replacements = replacements;
>     }
> 
>     @Override
>     public JSType caseTemplateType(TemplateType type) {
>       if (replacements.hasTemplateKey(type)) {
>         madeChanges = true;
>         JSType replacement = replacements.getTemplateType(type);
>         return replacements.getTemplateType(type);
>       } else {
>         return type;
>       }
>     }
>   }
> 
1318a1341,1351
>       }
>     }
> 
>     if (propertyType != null && objType != null) {
>       JSType restrictedObjType = objType.restrictByNotNullOrUndefined();
>       if (restrictedObjType.isTemplatizedType()
>           && propertyType.hasAnyTemplateTypes()) {
>         TemplateTypeMap typeMap = restrictedObjType.getTemplateTypeMap();
>         TemplateTypeMapReplacer replacer = new TemplateTypeMapReplacer(
>             registry, typeMap);
>         propertyType = propertyType.visit(replacer);
