21a22
> import com.google.javascript.jscomp.AbstractCompiler.LifeCycleStage;
22a24
> import com.google.javascript.jscomp.Scope.Var;
44a47
>   private List<Node> removedNodes = Lists.newArrayList();
50,54d52
<   
<   OptimizeParameters(AbstractCompiler compiler, NameReferenceGraph unused) {
<     this(compiler);
<   }
< 
57a56,57
>     Preconditions.checkState(
>         compiler.getLifeCycleStage() == LifeCycleStage.NORMALIZED);
71a72,77
> 
>     
>     
>     for (Node n : removedNodes) {
>       definitions.removeReferences(n);
>     }
185a192
>     boolean continueLooking = false;
194c201
<         buildParameterList(parameters, cur);
---
>         continueLooking = buildParameterList(parameters, cur, site.scope);
197c204
<         findConstantParameters(parameters, cur);
---
>         continueLooking= findFixedParameters(parameters, cur);
198a206,213
>       if (!continueLooking) {
>         return;
>       }
>     }
> 
>     continueLooking = adjustForSideEffects(parameters);
>     if (!continueLooking) {
>       return;
206c221
<       optimizeCallSite(parameters, call);
---
>       optimizeCallSite(defFinder, parameters, call);
217c232,281
<   private void findConstantParameters(List<Parameter> parameters, Node cur) {
---
>   
> 
> 
> 
>   private boolean adjustForSideEffects(List<Parameter> parameters) {
>     
>     
> 
>     
>     
> 
>     boolean anyMovable = false;
>     boolean seenUnmovableSideEffects = false;
>     boolean seenUnmoveableSideEfffected = false;
>     for (int i = parameters.size() - 1; i >= 0; i--) {
>       Parameter current = parameters.get(i);
> 
>       
>       
>       
>       
>       
> 
>       if (current.shouldRemove
>           && ((seenUnmovableSideEffects && current.canBeSideEffected())
>           || (seenUnmoveableSideEfffected && current.hasSideEffects()))) {
>         current.shouldRemove = false;
>       }
> 
>       if (current.shouldRemove) {
>         anyMovable = true;
>       } else {
>         if (current.canBeSideEffected) {
>           seenUnmoveableSideEfffected = true;
>         }
> 
>         if (current.hasSideEffects) {
>           seenUnmovableSideEffects = true;
>         }
>       }
>     }
>     return anyMovable;
>   }
> 
>   
> 
> 
> 
>   private boolean findFixedParameters(List<Parameter> parameters, Node cur) {
>     boolean anyMovable = false;
219a284
>       Parameter p;
221,225c286,296
<         parameters.add(new Parameter(cur, false));
<       } else if (parameters.get(index).shouldRemove()) {
<         Node value = parameters.get(index).getArg();
<         if (!nodesAreEqual(cur, value)) {
<           parameters.get(index).setShouldRemove(false);
---
>         p = new Parameter(cur, false);
>         parameters.add(p);
>       } else {
>         p = parameters.get(index);
>         if (p.shouldRemove()) {
>           Node value = p.getArg();
>           if (!cur.isEquivalentTo(value)) {
>             p.setShouldRemove(false);
>           } else {
>             anyMovable = true;
>           }
227a299,300
> 
>       setParameterSideEffectInfo(p, cur);
233a307,308
> 
>     return anyMovable;
236c311,316
<   private void buildParameterList(List<Parameter> parameters, Node cur) {
---
>   
> 
> 
>   private boolean buildParameterList(
>       List<Parameter> parameters, Node cur, Scope s) {
>     boolean anyMovable = false;
238c318,324
<       parameters.add(new Parameter(cur, NodeUtil.isLiteralValue(cur, false)));
---
>       boolean movable = isMovableValue(cur, s);
>       Parameter p = new Parameter(cur, movable);
>       setParameterSideEffectInfo(p, cur);
>       parameters.add(p);
>       if (movable) {
>         anyMovable = true;
>       }
239a326,373
>     return anyMovable;
>   }
> 
>   private void setParameterSideEffectInfo(Parameter p, Node value) {
>     if (!p.hasSideEffects()) {
>       p.setHasSideEffects(NodeUtil.mayHaveSideEffects(value, compiler));
>     }
> 
>     if (!p.canBeSideEffected()) {
>       p.setCanBeSideEffected(NodeUtil.canBeSideEffected(value));
>     }
>   }
> 
> 
>   
> 
> 
> 
>   private boolean isMovableValue(Node n, Scope s) {
>     
>     
>     
>     switch (n.getType()) {
>       case Token.THIS:
>         return false;
>       case Token.FUNCTION:
>         
>         
>         
>         return false;
>       case Token.NAME:
>         if (n.getString().equals("arguments")) {
>           return false;
>         } else {
>           Var v = s.getVar(n.getString());
>           if (v != null && v.isLocal()) {
>             return false;
>           }
>         }
>         break;
>     }
> 
>     for (Node c = n.getFirstChild(); c != null; c = c.getNext()) {
>       if (!isMovableValue(c, s)) {
>         return false;
>       }
>     }
>     return true;
255c389,390
<   private void optimizeCallSite(List<Parameter> parameters, Node call) {
---
>   private void optimizeCallSite(
>       SimpleDefinitionFinder defFinder, List<Parameter> parameters, Node call) {
257,258c392,394
<       if (parameters.get(index).shouldRemove()) {
<         eliminateCallParamAt(call, index);
---
>       Parameter p = parameters.get(index);
>       if (p.shouldRemove()) {
>         eliminateCallParamAt(defFinder, p, call, index);
267,278d402
< 
< 
< 
<   private boolean nodesAreEqual(Node n1, Node n2) {
<     return NodeUtil.isImmutableValue(n1) && NodeUtil.isImmutableValue(n2) &&
<         n1.isEquivalentTo(n2);
<   }
< 
<   
< 
< 
< 
281a406,407
>     private boolean hasSideEffects;
>     private boolean canBeSideEffected;
298a425,440
> 
>     public void setHasSideEffects(boolean hasSideEffects) {
>       this.hasSideEffects = hasSideEffects;
>     }
> 
>     public boolean hasSideEffects() {
>       return hasSideEffects;
>     }
> 
>     public void setCanBeSideEffected(boolean canBeSideEffected) {
>       this.canBeSideEffected = canBeSideEffected;
>     }
> 
>     public boolean canBeSideEffected() {
>       return canBeSideEffected;
>     }
315,316c457,458
<     Node newVar = NodeUtil.newVarNode(varName.getQualifiedName(),
<         value.cloneTree());
---
>     Preconditions.checkState(value.getParent() == null);
>     Node newVar = NodeUtil.newVarNode(varName.getString(), value);
375c517,520
<   private Node eliminateCallParamAt(Node call, int argIndex) {
---
> 
> 
>   private Node eliminateCallParamAt(
>       SimpleDefinitionFinder defFinder, Parameter p, Node call, int argIndex) {
383a529,534
>       
>       
>       
>       if (p.getArg() != formalArgPtr) {
>         removedNodes.add(formalArgPtr);
>       }
