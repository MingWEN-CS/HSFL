398,402c398,408
<     for (int i = 1; i < depth && n.hasChildren(); i++) {
<       n = n.getFirstChild();
<     }
<     if (n.hasChildren()) {
<       flattenNameRef(alias, n.getFirstChild(), n, originalName);
---
>     int nType = n.getType();
>     boolean isQName = nType == Token.NAME || nType == Token.GETPROP;
>     boolean isObjKey = nType == Token.STRING || nType == Token.NUMBER;
>     Preconditions.checkState(isObjKey || isQName);
>     if (isQName) {
>       for (int i = 1; i < depth && n.hasChildren(); i++) {
>         n = n.getFirstChild();
>       }
>       if (n.hasChildren()) {
>         flattenNameRef(alias, n.getFirstChild(), n, originalName);
>       }
729,730c735,736
<       Node value = key.getNext();
<       nextKey = value.getNext();
---
>       Node value = key.getFirstChild();
>       nextKey = key.getNext();
747c753
<         objlit.removeChild(value);
---
>         value.detachFromParent();
754c760,761
<         objlit.replaceChildAfter(key, refNode);
---
> 
>         key.replaceChild(value, refNode);
